<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Use Case List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Arial', sans-serif;
      background: #f5f7fa;
      color: #23313d;
    }
    .header {
      background: #10243d;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 30px 20px 30px;
      border-bottom: 2px solid #0a6ed1;
    }
    .header-title {
      font-size: 2rem;
      font-weight: bold;
      letter-spacing: -1px;
    }
    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .btn {
      background: #0a6ed1;
      color: #fff;
      border: none;
      padding: 0.6em 1.2em;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background .2s;
      font-weight: 600;
      outline: none;
    }
    .btn:hover {
      background: #094c93;
    }
    .select {
      padding: 0.45em 0.8em;
      border-radius: 8px;
      border: 1px solid #dde8f2;
      background: #fff;
      font-size: 1rem;
      min-width: 150px;
    }
    .main-content {
      max-width: 1000px;
      margin: 32px auto 0 auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px #10243d12;
      padding: 36px;
    }
    .use-case-row {
      border-bottom: 1px solid #e6ecf5;
      padding: 18px 0;
      transition: background 0.2s;
    }
    .use-case-row:last-child {
      border-bottom: none;
    }
    .use-case-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #0a6ed1;
      margin-bottom: 6px;
      letter-spacing: -.5px;
    }
    .tags {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tag {
      background: #eaf6fd;
      color: #0a6ed1;
      border-radius: 6px;
      padding: 2px 12px;
      font-size: .99em;
      font-weight: 500;
      display: inline-block;
    }
    details summary {
      cursor: pointer;
      font-weight: 500;
      color: #10243d;
      outline: none;
      font-size: 1.07em;
    }
    details[open] summary {
      color: #0a6ed1;
    }
    .details-body {
      margin-top: 14px;
      padding-left: 8px;
    }
    .embed-arch {
      margin: 14px 0 14px 0;
    }
    .story-links ul {
      list-style: none;
      padding-left: 0;
      margin: 0 0 6px 0;
    }
    .story-links li a {
      color: #094c93;
      text-decoration: underline;
      transition: color .2s;
    }
    .story-links li a:hover {
      color: #10243d;
    }
    .created-at {
      color: #6d8095;
      font-size: .96em;
      margin-top: 8px;
    }
    /* Modal styling */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(16,36,61,0.15);
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: #fff;
      padding: 2.2em 2.8em 2.2em 2.8em;
      border-radius: 14px;
      box-shadow: 0 8px 40px #0a6ed150;
      max-width: 430px;
      width: 100%;
      position: relative;
      animation: popup-in .24s cubic-bezier(.52,.19,.43,.92);
    }
    @keyframes popup-in {
      0% { transform: translateY(40px) scale(.96);}
      100% { transform: translateY(0) scale(1);}
    }
    .close {
      position: absolute;
      top: 14px; right: 22px;
      font-size: 1.5rem;
      color: #bbb;
      background: none;
      border: none;
      cursor: pointer;
      transition: color .2s;
      font-weight: bold;
    }
    .close:hover {
      color: #0a6ed1;
    }
    .modal-content label {
      display: block;
      margin-bottom: 3px;
      font-weight: 500;
      margin-top: 1.1em;
      font-size: 1em;
    }
    .modal-content input, .modal-content textarea {
      width: 100%;
      border-radius: 7px;
      border: 1px solid #dbe6ef;
      padding: 8px 10px;
      font-size: 1rem;
      background: #f8fbfd;
      margin-bottom: 7px;
    }
    .modal-content textarea {
      resize: vertical;
      min-height: 48px;
    }
    .modal-content .btn {
      width: 100%;
      margin-top: 1.2em;
    }
    @media (max-width: 700px) {
      .main-content { padding: 13px; }
      .modal-content { padding: 1em; }
      .header { flex-direction: column; gap: 14px; padding: 18px 6px;}
      .header-title { font-size: 1.28em;}
    }
  </style>
</head>
<body>
  <div class="header">
    <span class="header-title">Use Case List</span>
    <div class="header-controls">
      <select class="select" id="tagFilter">
        <option value="">Filter by tag...</option>
      </select>
      <button class="btn" id="addTagBtn" type="button">+ Add Tag</button>
      <button class="btn" id="addUseCaseBtn" type="button">Add Use Case</button>
    </div>
  </div>
  <div class="main-content" id="useCaseList">
    <p>Loading use cases…</p>
  </div>

  <!-- Add Use Case Modal -->
  <div class="modal" id="addUseCaseModal">
    <div class="modal-content">
      <button class="close" id="closeModalBtn">&times;</button>
      <h2 style="margin-top:0">Add New Use Case</h2>
      <form id="useCaseForm" autocomplete="off">
        <label for="useCaseTitle">Title</label>
        <input id="useCaseTitle" name="title" required />

        <label for="useCaseDesc">Description</label>
        <textarea id="useCaseDesc" name="desc" rows="2"></textarea>

        <label for="useCaseEmbed">Architecture Embed Code</label>
        <textarea id="useCaseEmbed" name="embed_url" rows="2"></textarea>

        <label>Customer Story Link 1 Label</label>
        <input id="link1_label" name="link1_label" type="text"/>
        <label>Customer Story Link 1 URL</label>
        <input id="link1_url" name="link1_url" type="url"/>

        <label>Customer Story Link 2 Label</label>
        <input id="link2_label" name="link2_label" type="text"/>
        <label>Customer Story Link 2 URL</label>
        <input id="link2_url" name="link2_url" type="url"/>

        <label>Customer Story Link 3 Label</label>
        <input id="link3_label" name="link3_label" type="text"/>
        <label>Customer Story Link 3 URL</label>
        <input id="link3_url" name="link3_url" type="url"/>

        <label for="useCaseTags">Tags (comma separated)</label>
        <input id="useCaseTags" name="tags"/>

        <button class="btn" type="submit">Submit</button>
      </form>
    </div>
  </div>

  <!-- Add Tag Modal -->
  <div class="modal" id="addTagModal">
    <div class="modal-content">
      <button class="close" id="closeTagModalBtn">&times;</button>
      <h2>Add New Tag</h2>
      <form id="tagForm" autocomplete="off">
        <label for="tagName">Tag Name</label>
        <input id="tagName" name="tag" required />
        <button class="btn" type="submit">Add Tag</button>
      </form>
    </div>
  </div>

  <script>
    // Supabase config
    const SUPABASE_URL = 'https://cgsfmpkcewemokbegnnt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnc2ZtcGtjZXdlbW9rYmVnbm50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MzMyNzIsImV4cCI6MjA2OTQwOTI3Mn0.-5paJnbUuFWoIRSVAYcx3LRPYH5_HRjwjYcupvRKYLc';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Modal logic
    function modalHandler(modalId, openBtnId, closeBtnId) {
      const modal = document.getElementById(modalId);
      if (openBtnId) document.getElementById(openBtnId).onclick = () => modal.classList.add('active');
      document.getElementById(closeBtnId).onclick = () => modal.classList.remove('active');
      modal.onclick = e => { if (e.target === modal) modal.classList.remove('active'); };
    }
    modalHandler('addUseCaseModal', 'addUseCaseBtn', 'closeModalBtn');
    modalHandler('addTagModal', 'addTagBtn', 'closeTagModalBtn');

    // Use Cases Display Logic
    const useCaseList = document.getElementById('useCaseList');
    async function loadUseCases(filterTag) {
      useCaseList.innerHTML = "<p>Loading use cases…</p>";
      let q = supabase.from('use_cases').select('*').order('created_at', {ascending: false});
      if (filterTag) q = q.contains('tags', [filterTag]);
      let { data, error } = await q;
      if (error) {
        useCaseList.innerHTML = "<p style='color:crimson'>Failed to load use cases.</p>";
        return;
      }
      if (!data || data.length === 0) {
        useCaseList.innerHTML = `<p>No use cases${filterTag ? ` for tag "${filterTag}"` : ""}. Be first to add one!</p>`;
        return;
      }
      useCaseList.innerHTML = data.map(uc => `
        <div class="use-case-row">
          <div class="use-case-title">${uc.title}</div>
          <div class="tags">${uc.tags && uc.tags.length ? uc.tags.map(t=>`<span class="tag">${t}</span>`).join("") : ""}</div>
          <details>
            <summary>Show Details</summary>
            <div class="details-body">
              <div style="margin-bottom:8px;"><strong>Description:</strong><br>${uc.description || ""}</div>
              <div class="embed-arch">
                <strong>Architecture:</strong>
                <div>${uc.embed_url ? uc.embed_url : "<em>None</em>"}</div>
              </div>
              <div class="story-links">
                <strong>Customer Stories:</strong>
                <ul>
                  ${uc.link1_url ? `<li><a href="${uc.link1_url}" target="_blank">${uc.link1_label||uc.link1_url}</a></li>` : ""}
                  ${uc.link2_url ? `<li><a href="${uc.link2_url}" target="_blank">${uc.link2_label||uc.link2_url}</a></li>` : ""}
                  ${uc.link3_url ? `<li><a href="${uc.link3_url}" target="_blank">${uc.link3_label||uc.link3_url}</a></li>` : ""}
                </ul>
              </div>
              <div class="created-at">Created: ${new Date(uc.created_at).toLocaleString()}</div>
            </div>
          </details>
        </div>
      `).join("");
    }
    loadUseCases();

    // Add Use Case Form logic
    document.getElementById('useCaseForm').onsubmit = async e => {
      e.preventDefault();
      // Collect data
      const title = document.getElementById('useCaseTitle').value.trim();
      const description = document.getElementById('useCaseDesc').value.trim();
      const embed_url = document.getElementById('useCaseEmbed').value.trim();
      const link1_label = document.getElementById('link1_label').value.trim();
      const link1_url = document.getElementById('link1_url').value.trim();
      const link2_label = document.getElementById('link2_label').value.trim();
      const link2_url = document.getElementById('link2_url').value.trim();
      const link3_label = document.getElementById('link3_label').value.trim();
      const link3_url = document.getElementById('link3_url').value.trim();
      const tags = document.getElementById('useCaseTags').value.split(',').map(s=>s.trim()).filter(Boolean);

      // Insert into Supabase
      const { error } = await supabase.from('use_cases').insert([{
        title, description, embed_url, link1_label, link1_url,
        link2_label, link2_url, link3_label, link3_url, tags
      }]);
      if (error) {
        alert("Failed to add use case: "+error.message);
      } else {
        document.getElementById('addUseCaseModal').classList.remove('active');
        loadUseCases();
      }
      e.target.reset();
    }

    // Tag filter logic (from all use cases)
    async function populateTagFilter() {
      let { data } = await supabase.from('use_cases').select('tags');
      const tags = new Set();
      (data||[]).forEach(uc=>{
        if(Array.isArray(uc.tags)) uc.tags.forEach(t=>tags.add(t));
      });
      const sel = document.getElementById('tagFilter');
      sel.innerHTML = '<option value="">Filter by tag...</option>' +
        Array.from(tags).sort().map(t=>`<option value="${t}">${t}</option>`).join("");
    }
    populateTagFilter();

    // Reload on filter
    document.getElementById('tagFilter').onchange = function() {
      loadUseCases(this.value);
    }

    // Add Tag Modal (for now: only UI, as tags are not in separate table)
    document.getElementById('tagForm').onsubmit = async function(e) {
      e.preventDefault();
      // For demo, just add to tag filter for now
      let tag = document.getElementById('tagName').value.trim();
      if (tag) {
        let sel = document.getElementById('tagFilter');
        let exists = Array.from(sel.options).some(o=>o.value===tag);
        if (!exists) {
          sel.innerHTML += `<option value="${tag}">${tag}</option>`;
          alert('Tag "'+tag+'" added (UI only; attach to use cases via the form)');
        }
      }
      document.getElementById('addTagModal').classList.remove('active');
      e.target.reset();
    };
  </script>
</body>
</html>
