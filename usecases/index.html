<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Use Case List</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <style>
    /* ...[keep all CSS from previous step, unchanged]... */
    /* Copy the previous CSS exactly as above */
  </style>
</head>
<body>
  <div class="header">
    <span class="header-title">Use Case List</span>
    <div class="header-controls">
      <select class="select" id="tagFilter">
        <option value="">Filter by tag...</option>
      </select>
      <button class="btn" id="addTagBtn">+ Add Tag</button>
      <button class="btn" id="addUseCaseBtn">Add Use Case</button>
    </div>
  </div>
  <div class="main-content" id="useCaseList">
    <p style="color:#3a495f; font-size:1.1rem;">Loading use cases…</p>
  </div>
  <!-- Modal for use case -->
  <div class="modal" id="addUseCaseModal">
    <div class="modal-content">
      <button class="close" id="closeModalBtn">&times;</button>
      <h2>Add New Use Case</h2>
      <form id="useCaseForm">
        <div class="form-row">
          <label for="useCaseTitle">Title</label>
          <input id="useCaseTitle" name="title" required />
        </div>
        <div class="form-row">
          <label for="useCaseDesc">Description</label>
          <textarea id="useCaseDesc" name="desc" rows="3"></textarea>
        </div>
        <div class="form-row">
          <label for="useCaseEmbed">Architecture Embed Code</label>
          <textarea id="useCaseEmbed" name="embed_url" rows="2"></textarea>
        </div>
        <div class="form-row">
          <label>Customer Story Link 1 Label</label>
          <input id="link1_label" name="link1_label" type="text"/>
          <label>Customer Story Link 1 URL</label>
          <input id="link1_url" name="link1_url" type="url"/>
        </div>
        <div class="form-row">
          <label>Customer Story Link 2 Label</label>
          <input id="link2_label" name="link2_label" type="text"/>
          <label>Customer Story Link 2 URL</label>
          <input id="link2_url" name="link2_url" type="url"/>
        </div>
        <div class="form-row">
          <label>Customer Story Link 3 Label</label>
          <input id="link3_label" name="link3_label" type="text"/>
          <label>Customer Story Link 3 URL</label>
          <input id="link3_url" name="link3_url" type="url"/>
        </div>
        <div class="form-row">
          <label for="useCaseTags">Tags (comma separated)</label>
          <input id="useCaseTags" name="tags"/>
        </div>
        <button class="btn" type="submit">Submit</button>
      </form>
    </div>
  </div>
  <!-- Modal for Add Tag -->
  <div class="modal" id="addTagModal">
    <div class="modal-content">
      <button class="close" id="closeTagModalBtn">&times;</button>
      <h2>Add New Tag</h2>
      <form id="tagForm">
        <div class="form-row">
          <label for="tagName">Tag Name</label>
          <input id="tagName" name="tag" required />
        </div>
        <button class="btn" type="submit">Add Tag</button>
      </form>
    </div>
  </div>
  <script>
    // Supabase config
    const SUPABASE_URL = 'https://cgsfmpkcewemokbegnnt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNnc2ZtcGtjZXdlbW9rYmVnbm50Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MzMyNzIsImV4cCI6MjA2OTQwOTI3Mn0.-5paJnbUuFWoIRSVAYcx3LRPYH5_HRjwjYcupvRKYLc';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Modal logic
    const addBtn = document.getElementById('addUseCaseBtn');
    const modal = document.getElementById('addUseCaseModal');
    const closeBtn = document.getElementById('closeModalBtn');
    addBtn.onclick = () => modal.classList.add('active');
    closeBtn.onclick = () => modal.classList.remove('active');
    modal.onclick = e => { if(e.target === modal) modal.classList.remove('active'); };

    // Add Tag Modal logic
    const addTagBtn = document.getElementById('addTagBtn');
    const addTagModal = document.getElementById('addTagModal');
    const closeTagModalBtn = document.getElementById('closeTagModalBtn');
    addTagBtn.onclick = () => addTagModal.classList.add('active');
    closeTagModalBtn.onclick = () => addTagModal.classList.remove('active');
    addTagModal.onclick = e => { if(e.target === addTagModal) addTagModal.classList.remove('active'); };

    // Use Cases Display Logic
    const useCaseList = document.getElementById('useCaseList');
    async function loadUseCases() {
      useCaseList.innerHTML = "<p>Loading use cases…</p>";
      let { data, error } = await supabase.from('use_cases').select('*').order('created_at', {ascending: false});
      if(error) {
        useCaseList.innerHTML = "<p style='color:crimson'>Failed to load use cases.</p>";
        return;
      }
      if(!data || data.length === 0) {
        useCaseList.innerHTML = "<p>No use cases yet. Be first to add one!</p>";
        return;
      }
      useCaseList.innerHTML = data.map(uc => `
        <div style="border-bottom:1px solid #e3e9f0; padding: 18px 0;">
          <h3>${uc.title}</h3>
          <div style="margin-bottom:6px; color:#466;">
            ${uc.tags && uc.tags.length ? uc.tags.map(t=>`<span style="background:#e9f6fd;color:#0a6ed1;border-radius:6px;padding:2px 8px;margin-right:4px;font-size:.95em">${t}</span>`).join("") : ""}
          </div>
          <details>
            <summary style="cursor:pointer;color:#0a6ed1; font-weight:bold;">Expand details</summary>
            <div style="margin-top:10px;">
              <div style="margin-bottom:8px;">${uc.description || ""}</div>
              <div style="margin-bottom:8px;">
                <strong>Architecture:</strong>
                <div>${uc.embed_url ? uc.embed_url : "<em>None</em>"}</div>
              </div>
              <div>
                <strong>Customer Stories:</strong>
                <ul>
                  ${uc.link1_url ? `<li><a href="${uc.link1_url}" target="_blank">${uc.link1_label||uc.link1_url}</a></li>` : ""}
                  ${uc.link2_url ? `<li><a href="${uc.link2_url}" target="_blank">${uc.link2_label||uc.link2_url}</a></li>` : ""}
                  ${uc.link3_url ? `<li><a href="${uc.link3_url}" target="_blank">${uc.link3_label||uc.link3_url}</a></li>` : ""}
                </ul>
              </div>
              <div style="font-size:0.9em;color:#888;margin-top:7px;">Created: ${new Date(uc.created_at).toLocaleString()}</div>
            </div>
          </details>
        </div>
      `).join("");
    }
    loadUseCases();

    // Add Use Case Form logic
    document.getElementById('useCaseForm').onsubmit = async e => {
      e.preventDefault();
      // Collect data
      const title = document.getElementById('useCaseTitle').value.trim();
      const description = document.getElementById('useCaseDesc').value.trim();
      const embed_url = document.getElementById('useCaseEmbed').value.trim();
      const link1_label = document.getElementById('link1_label').value.trim();
      const link1_url = document.getElementById('link1_url').value.trim();
      const link2_label = document.getElementById('link2_label').value.trim();
      const link2_url = document.getElementById('link2_url').value.trim();
      const link3_label = document.getElementById('link3_label').value.trim();
      const link3_url = document.getElementById('link3_url').value.trim();
      const tags = document.getElementById('useCaseTags').value.split(',').map(s=>s.trim()).filter(Boolean);

      // Insert into Supabase
      const { error } = await supabase.from('use_cases').insert([{
        title, description, embed_url, link1_label, link1_url,
        link2_label, link2_url, link3_label, link3_url, tags
      }]);
      if(error) {
        alert("Failed to add use case: "+error.message);
      } else {
        modal.classList.remove('active');
        loadUseCases();
      }
      // Optional: Reset form
      e.target.reset();
    }

    // Tag filter logic (simplified for now)
    // You can improve this to read tags from all use cases, dedupe, and populate dropdown.
    async function populateTagFilter() {
      let { data } = await supabase.from('use_cases').select('tags');
      const tags = new Set();
      (data||[]).forEach(uc=>{
        if(Array.isArray(uc.tags)) uc.tags.forEach(t=>tags.add(t));
      });
      const sel = document.getElementById('tagFilter');
      sel.innerHTML = '<option value="">Filter by tag...</option>' +
        Array.from(tags).map(t=>`<option value="${t}">${t}</option>`).join("");
    }
    populateTagFilter();

    // Reload on filter
    document.getElementById('tagFilter').onchange = async function() {
      const val = this.value;
      if(!val) return loadUseCases();
      let { data, error } = await supabase.from('use_cases').select('*').contains('tags', [val]);
      if(error) {
        useCaseList.innerHTML = "<p style='color:crimson'>Failed to filter use cases.</p>";
        return;
      }
      if(!data || data.length === 0) {
        useCaseList.innerHTML = `<p>No use cases for tag "${val}".</p>`;
        return;
      }
      useCaseList.innerHTML = data.map(uc => `
        <div style="border-bottom:1px solid #e3e9f0; padding: 18px 0;">
          <h3>${uc.title}</h3>
          <div style="margin-bottom:6px; color:#466;">
            ${uc.tags && uc.tags.length ? uc.tags.map(t=>`<span style="background:#e9f6fd;color:#0a6ed1;border-radius:6px;padding:2px 8px;margin-right:4px;font-size:.95em">${t}</span>`).join("") : ""}
          </div>
          <details>
            <summary style="cursor:pointer;color:#0a6ed1; font-weight:bold;">Expand details</summary>
            <div style="margin-top:10px;">
              <div style="margin-bottom:8px;">${uc.description || ""}</div>
              <div style="margin-bottom:8px;">
                <strong>Architecture:</strong>
                <div>${uc.embed_url ? uc.embed_url : "<em>None</em>"}</div>
              </div>
              <div>
                <strong>Customer Stories:</strong>
                <ul>
                  ${uc.link1_url ? `<li><a href="${uc.link1_url}" target="_blank">${uc.link1_label||uc.link1_url}</a></li>` : ""}
                  ${uc.link2_url ? `<li><a href="${uc.link2_url}" target="_blank">${uc.link2_label||uc.link2_url}</a></li>` : ""}
                  ${uc.link3_url ? `<li><a href="${uc.link3_url}" target="_blank">${uc.link3_label||uc.link3_url}</a></li>` : ""}
                </ul>
              </div>
              <div style="font-size:0.9em;color:#888;margin-top:7px;">Created: ${new Date(uc.created_at).toLocaleString()}</div>
            </div>
          </details>
        </div>
      `).join("");
    }
  </script>
</body>
</html>
